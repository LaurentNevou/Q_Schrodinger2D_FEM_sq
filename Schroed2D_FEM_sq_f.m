function[E,psi]=Schroed2D_FEM_sq_f(x,y,V0,Mass,n)

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% Constants %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

h=6.62606896E-34;               %% Planck constant [J.s]
hbar=h/(2*pi);
e=1.602176487E-19;              %% electron charge [C]
me=9.10938188E-31;              %% electron mass [kg]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Nx=length(x);
Ny=length(y);

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

dxb(2:Nx) = x(2:Nx) - x(1:Nx-1);      %% backward difference (i) - (i-1)
dxb(1) = dxb(2);
dxf(1:Nx-1) = x(2:Nx) - x(1:Nx-1);    %% forward difference  (i+1) - (i)
dxf(Nx) = dxf(Nx-1);

dyb(2:Ny) = y(2:Ny) - y(1:Ny-1);      %% backward difference (i) - (i-1)
dyb(1) = dyb(2);
dyf(1:Ny-1) = y(2:Ny) - y(1:Ny-1);    %% forward difference  (i+1) - (i)
dyf(Ny) = dyf(Ny-1);

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%% Building of the operators %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%% Second derivative X %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% DX2(Ny=5,Nx=4); %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                                                                  %
%  -2   0   0   0   0 | 1   0   0   0   0 | 0   0   0   0   0 | 0   0   0   0   0  %
%   0  -2   0   0   0 | 0   1   0   0   0 | 0   0   0   0   0 | 0   0   0   0   0  %
%   0   0  -2   0   0 | 0   0   1   0   0 | 0   0   0   0   0 | 0   0   0   0   0  %
%   0   0   0  -2   0 | 0   0   0   1   0 | 0   0   0   0   0 | 0   0   0   0   0  %
%   0   0   0   0  -2 | 0   0   0   0   1 | 0   0   0   0   0 | 0   0   0   0   0  %
%   -----------------------------------------------------------------------------  %
%   1   0   0   0   0 |-2   0   0   0   0 | 1   0   0   0   0 | 0   0   0   0   0  %
%   0   1   0   0   0 | 0  -2   0   0   0 | 0   1   0   0   0 | 0   0   0   0   0  %
%   0   0   1   0   0 | 0   0  -2   0   0 | 0   0   1   0   0 | 0   0   0   0   0  %
%   0   0   0   1   0 | 0   0   0  -2   0 | 0   0   0   1   0 | 0   0   0   0   0  %
%   0   0   0   0   1 | 0   0   0   0  -2 | 0   0   0   0   1 | 0   0   0   0   0  %
%   -----------------------------------------------------------------------------  %
%   0   0   0   0   0 | 1   0   0   0   0 |-2   0   0   0   0 | 1   0   0   0   0  %
%   0   0   0   0   0 | 0   1   0   0   0 | 0  -2   0   0   0 | 0   1   0   0   0  %
%   0   0   0   0   0 | 0   0   1   0   0 | 0   0  -2   0   0 | 0   0   1   0   0  %
%   0   0   0   0   0 | 0   0   0   1   0 | 0   0   0  -2   0 | 0   0   0   1   0  %
%   0   0   0   0   0 | 0   0   0   0   1 | 0   0   0   0  -2 | 0   0   0   0   1  %
%   -----------------------------------------------------------------------------  %
%   0   0   0   0   0 | 0   0   0   0   0 | 1   0   0   0   0 |-2   0   0   0   0  %
%   0   0   0   0   0 | 0   0   0   0   0 | 0   1   0   0   0 | 0  -2   0   0   0  %
%   0   0   0   0   0 | 0   0   0   0   0 | 0   0   1   0   0 | 0   0  -2   0   0  %
%   0   0   0   0   0 | 0   0   0   0   0 | 0   0   0   1   0 | 0   0   0  -2   0  %
%   0   0   0   0   0 | 0   0   0   0   0 | 0   0   0   0   1 | 0   0   0   0  -2  %
%                                                                                  %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

AA   = ones(1,Nx)   ./ ( dxb .* dxf );
BB_b = ones(1,Nx-1) ./ ( dxb(2:Nx)   .* ( dxb(2:Nx)   + dxf(2:Nx)   ) );
BB_f = ones(1,Nx-1) ./ ( dxf(1:Nx-1) .* ( dxb(1:Nx-1) + dxf(1:Nx-1) ) );


AAA=repmat(AA,Ny,1);AAA=AAA(:);
Axy_b=repmat(BB_b,Ny,1); Axy_b=Axy_b(:);
Axy_f=repmat(BB_f,Ny,1); Axy_f=Axy_f(:);

DX2 = -(2)*diag(AAA) + (2)*diag(Axy_b,-Ny) + (2)*diag(Axy_f,Ny) ;

%%%%%%%%%%%%%%%%%%%%%%%%%%% Second derivative Y %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% DY2(Ny=5,Nx=4); %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                                                                  %
%  -2   1   0   0   0 | 0   0   0   0   0 | 0   0   0   0   0 | 0   0   0   0   0  %
%   1  -2   1   0   0 | 0   0   0   0   0 | 0   0   0   0   0 | 0   0   0   0   0  %
%   0   1  -2   1   0 | 0   0   0   0   0 | 0   0   0   0   0 | 0   0   0   0   0  %
%   0   0   1  -2   1 | 0   0   0   0   0 | 0   0   0   0   0 | 0   0   0   0   0  %
%   0   0   0   1  -2 | 0   0   0   0   0 | 0   0   0   0   0 | 0   0   0   0   0  %
%   -----------------------------------------------------------------------------  %
%   0   0   0   0   0 |-2   1   0   0   0 | 0   0   0   0   0 | 0   0   0   0   0  %
%   0   0   0   0   0 | 1  -2   1   0   0 | 0   0   0   0   0 | 0   0   0   0   0  %
%   0   0   0   0   0 | 0   1  -2   1   0 | 0   0   0   0   0 | 0   0   0   0   0  %
%   0   0   0   0   0 | 0   0   1  -2   1 | 0   0   0   0   0 | 0   0   0   0   0  %
%   0   0   0   0   0 | 0   0   0   1  -2 | 0   0   0   0   0 | 0   0   0   0   0  %
%   -----------------------------------------------------------------------------  %
%   0   0   0   0   0 | 0   0   0   0   0 |-2   1   0   0   0 | 0   0   0   0   0  %
%   0   0   0   0   0 | 0   0   0   0   0 | 1  -2   1   0   0 | 0   0   0   0   0  %
%   0   0   0   0   0 | 0   0   0   0   0 | 0   1  -2   1   0 | 0   0   0   0   0  %
%   0   0   0   0   0 | 0   0   0   0   0 | 0   0   1  -2   1 | 0   0   0   0   0  %
%   0   0   0   0   0 | 0   0   0   0   0 | 0   0   0   1  -2 | 0   0   0   0   0  %
%   -----------------------------------------------------------------------------  %
%   0   0   0   0   0 | 0   0   0   0   0 | 0   0   0   0   0 |-2   1   0   0   0  %
%   0   0   0   0   0 | 0   0   0   0   0 | 0   0   0   0   0 | 1  -2   1   0   0  %
%   0   0   0   0   0 | 0   0   0   0   0 | 0   0   0   0   0 | 0   1  -2   1   0  %
%   0   0   0   0   0 | 0   0   0   0   0 | 0   0   0   0   0 | 0   0   1  -2   1  %
%   0   0   0   0   0 | 0   0   0   0   0 | 0   0   0   0   0 | 0   0   0   1  -2  %
%                                                                                  %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

AA   = ones(1,Ny)   ./ ( dyb .* dyf );
BB_b = ones(1,Ny-1) ./ ( dyb(2:Ny)   .* ( dyb(2:Ny)   + dyf(2:Ny)   ) );
BB_f = ones(1,Ny-1) ./ ( dyf(1:Ny-1) .* ( dyb(1:Ny-1) + dyf(1:Ny-1) ) );

DY22 =(-2)*diag(AA) + (2)*diag(BB_b,-1) + (2)*diag(BB_f,1);
DY2=[];
for i=1:length(x)
    DY2=blkdiag(DY2,DY22);
end

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%% Building of the Hamiltonien %%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

H=(-hbar^2/(2*me*Mass)) * ( DX2 + DY2 ) +  diag(V0(:)*e) ;

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%% Diagonalisation of the Hamiltonien %%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

H=sparse(H);
[PSI,Energy] = eigs(H,n,'SM');
E = diag(Energy)/e;

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%% Normalization of the Wavefunction %%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

for i=1:n
    psi_temp=reshape(PSI(:,i),Ny,Nx);
    psi(:,:,i) = psi_temp / sqrt( trapz( y' , trapz(x,abs(psi_temp).^2 ,2) , 1 )  );  % normalisation of the wave function psi
end

%psi=psi(:,:,end:-1:1);
%E=E(end:-1:1);

end
